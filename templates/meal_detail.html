
{% extends "base.html" %}
{% block title %}Результат анализа{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-md-5">
    <div class="glass p-2">
      <img src="{{ url_for('uploaded_file', filename=meal.filename) }}" class="img-fluid rounded" alt="meal">
    </div>
  </div>
  <div class="col-md-7">
    <div class="glass p-4">
      <h2 class="mb-3">{{ meal.dish_name or "Неопознанное блюдо" }}</h2>
      <div class="row g-3">
        <div class="col-6 col-lg-4">
          <div class="stat">
            <div class="stat-value">{{ meal.calories_kcal|round(0) if meal.calories_kcal else "—" }}</div>
            <div class="stat-label">ккал</div>
          </div>
        </div>
        <div class="col-6 col-lg-4">
          <div class="stat">
            <div class="stat-value">{{ meal.portion_grams|round(0) if meal.portion_grams else "—" }}</div>
            <div class="stat-label">грамм порция</div>
          </div>
        </div>
        <div class="col-6 col-lg-4">
          <div class="stat">
            <div class="stat-value">{{ (meal.confidence*100)|round(0) if meal.confidence is not none else "—" }}%</div>
            <div class="stat-label">уверенность</div>
          </div>
        </div>
      </div>

      <table class="table mt-3 table-light-text">
        <tr><th>Белки</th><td>{{ meal.proteins_g or "—" }} г</td></tr>
        <tr><th>Жиры</th><td>{{ meal.fats_g or "—" }} г</td></tr>
        <tr><th>Углеводы</th><td>{{ meal.carbs_g or "—" }} г</td></tr>
      </table>

      
      {% if components and components|length %}
      <h5 class="mt-4">Из чего состоит порция</h5>
      <table class="table align-middle table-light-text">
        <thead>
          <tr>
            <th>Компонент</th>
            <th>Состояние</th>
            <th>Метод</th>
            <th style="width:140px;">Кол-во</th>
            <th style="width:160px;">Масса, г</th>
            <th class="text-end">Ккал</th>
          </tr>
        </thead>
        <tbody>
          {% for c in components %}
          <tr>
            <td>{{ c.name }}</td>
            <td class="small">{{ c.cooked_state or "?" }}</td>
            <td class="small">{{ c.method or "—" }}</td>
            <td>{{ c.count if c.count is not none else "—" }}</td>
            <td>{{ c.est_grams|round(0) if c.est_grams is not none else "—" }}</td>
            <td class="text-end">{{ c.calories_kcal|round(0) if c.calories_kcal is not none else "—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}


      {% if meal.notes %}
        <div class="alert alert-secondary mt-3"><strong>Примечание:</strong> {{ meal.notes }}</div>
      {% endif %}

      <form method="post" action="{{ url_for('meal_toggle_tracking', meal_id=meal.id) }}" class="mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="count_in_tracking" id="countInTracking" 
                 {% if count_in_tracking %}checked{% endif %} 
                 onchange="this.form.submit()">
          <label class="form-check-label" for="countInTracking">
            Учитывать в трекинге целей
          </label>
        </div>
      </form>

      <a class="btn btn-outline-accent mt-3" href="{{ url_for('dashboard') }}">К дашборду</a>
      <a class="btn btn-link mt-3" href="{{ url_for('upload') }}">Анализировать ещё фото</a>
    </div>
  </div>
</div>
{% endblock %}
